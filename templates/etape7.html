<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Étape 7 - SET</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
    <div class="card">
        <div class="card-header bg-danger text-white">
            <h4>Étape 7: Demande d'achat</h4>
        </div>
        <div class="card-body">
            <p>Envoi de la demande d'achat avec le PAN chiffré à la banque.</p>
            
            <div class="alert alert-info">
                <strong>PC (Primary Account Number)</strong> est chiffré avec RSA 2048 bits.<br>
                Seule la banque peut le déchiffrer avec sa clé privée.
            </div>
            
            <button class="btn btn-primary mb-3" onclick="demanderAchat()">
                Demander l'achat
            </button>
            
            <div id="result" class="code-box p-3 bg-light mb-3" style="min-height: 100px;">
                En attente de demande...
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="/etape5" class="btn btn-secondary">← Étape 5</a>
                <a href="/etape8" class="btn btn-primary" id="nextBtn" style="display: none;">
                    Suivant → Étape 8: Achat 2 phases
                </a>
            </div>
        </div>
    </div>
    
    <script>
    function demanderAchat() {
        fetch('/api/demander_achat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('result').innerHTML = 
                `<strong>✅ Demande d'achat envoyée</strong><br><br>
                 <strong>Phase 1 - Autorisation :</strong><br>
                 • Code: ${data.autorisation.code}<br>
                 • Statut: ${data.autorisation.autorise ? 'AUTORISÉ' : 'REFUSÉ'}<br><br>
                 <strong>Phase 2 - Capture :</strong><br>
                 • Code: ${data.capture.code}<br>
                 • Statut: ${data.capture.capture ? 'CAPTURÉ' : 'ÉCHEC'}`;
            
            document.getElementById('nextBtn').style.display = 'block';
        });
    }
    </script>
</body>
</html>